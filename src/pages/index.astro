---
import Layout from '../layouts/Layout.astro';
---

<Layout title="ComfyUI Image Generator">
  <div class="max-w-3xl mx-auto">
    <!-- Generated Image Display -->
    <div class="bg-white p-4 rounded-lg shadow-md mb-4">
      <div id="generatedImage" class="w-full h-[560px] border rounded bg-gray-50 flex items-center justify-center relative">
        <p class="text-gray-500">Generated image will appear here</p>
      </div>
    </div>
    <!-- Prompt y botón -->
    <div class="bg-white p-4 rounded-lg shadow-md">
      <div class="flex flex-row justify-between">
        <h2 class="text-xl font-semibold mb-2">Generation Settings</h2>
        <div class="flex items-center">
          <span class="mr-2 text-sm font-medium text-gray-700">Basic</span>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="toggle-advanced" class="sr-only peer">
            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-indigo-500 rounded-full peer peer-checked:bg-indigo-600 transition-all"></div>
            <div class="absolute left-1 top-1 bg-white w-4 h-4 rounded-full shadow peer-checked:translate-x-5 transition-transform"></div>
          </label>
          <span class="ml-2 text-sm font-medium text-gray-700">Advanced</span>
        </div>
      </div>
      
      <div id="settings-basic-advanced" class="space-y-2">
        <div>
          <label class="block text-sm font-medium text-gray-700">Prompt</label>
          <textarea
            id="prompt"
            rows="1"
            class="mt-1 block w-full rounded-md border-2 border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2"
            placeholder="Introduce el prompt"
          ></textarea>
        </div>
        <div id="advanced-fields" style="display:none;">
          <div>
            <label class="block text-sm font-medium text-gray-700">Seed</label>
            <div class="flex space-x-2">
              <input type="number" id="seed" class="mt-1 block w-full rounded-md border-2 border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2" placeholder="-1 para aleatorio" min="-1" />
              <button id="last-seed" class="mt-1 px-3 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path fill-rule="evenodd" clip-rule="evenodd" d="M8.70714 3.29289C9.09766 3.68342 9.09766 4.31658 8.70714 4.70711L6.41424 7H14C17.866 7 21 10.134 21 14C21 17.866 17.866 21 14 21H8.15388C7.60159 21 7.15388 20.5523 7.15388 20C7.15388 19.4477 7.60159 19 8.15388 19H14C16.7615 19 19 16.7614 19 14C19 11.2386 16.7615 9 14 9H6.41424L8.70714 11.2929C9.09766 11.6834 9.09766 12.3166 8.70714 12.7071C8.31661 13.0976 7.68345 13.0976 7.29292 12.7071L2.58582 8L7.29292 3.29289C7.68345 2.90237 8.31661 2.90237 8.70714 3.29289Z" fill="#0F1729"/>
                </svg>
              </button>
              <button id="random-seed" class="mt-1 px-3 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <svg class="h-5 w-5" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill="none">
                  <g fill="#000000"> 
                    <path d="M5 4a1 1 0 000 2h.01a1 1 0 000-2H5zM7 8a1 1 0 011-1h.01a1 1 0 010 2H8a1 1 0 01-1-1zM11.01 10a1 1 0 100 2h.01a1 1 0 100-2h-.01z"/>   
                    <path fill-rule="evenodd" d="M3.25 1A2.25 2.25 0 001 3.25v9.5A2.25 2.25 0 003.25 15h9.5A2.25 2.25 0 0015 12.75v-9.5A2.25 2.25 0 0012.75 1h-9.5zM2.5 3.25a.75.75 0 01.75-.75h9.5a.75.75 0 01.75.75v9.5a.75.75 0 01-.75.75h-9.5a.75.75 0 01-.75-.75v-9.5z" clip-rule="evenodd"/>     
                  </g>                  
                </svg>
              </button>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">CFG</label>
            <div class="flex items-center space-x-2">
              <input type="range" id="cfg-range" min="0.1" max="10" value="1" step="0.01" class="flex-grow">
              <input type="number" id="cfg-number" min="0.1" max="10" value="1" step="0.01" class="w-14 text-right rounded-md border-2 border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-1 text-sm">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Steps</label>
            <div class="flex items-center space-x-2">
              <input type="range" id="steps-range" min="1" max="50" value="25" class="flex-grow">
              <input type="number" id="steps-number" min="1" max="50" value="25" class="w-14 text-right rounded-md border-2 border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-1 text-sm">
            </div>
          </div>
        </div>
        <button
          id="generate"
          class="w-full bg-indigo-600 text-white py-2 px-4 rounded hover:bg-indigo-700"
        >
          Generate Image
        </button>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { ImageGenerator } from '../lib/imageGenerator';
  import { appState } from '../lib/appState';

  const imageGenerator = new ImageGenerator();
  let lastUsedSeed: number | null = null;

  // Configurar callback para imágenes intermedias
  imageGenerator.setIntermediateImageCallback((imageUrl) => {
    appState.addIntermediateImage(imageUrl);
  });

  document.getElementById('generate')?.addEventListener('click', async () => {
    const prompt = (document.getElementById('prompt') as HTMLTextAreaElement).value;
    const seedInput = document.getElementById('seed') as HTMLInputElement;
    const cfgInput = document.getElementById('cfg-number') as HTMLInputElement;
    const stepsInput = document.getElementById('steps-number') as HTMLInputElement;
    
    if (!prompt) {
      alert('Por favor, ingresa un prompt');
      return;
    }

    try {
      appState.startLoading();
      const { imageUrl, seed } = await imageGenerator.generateImage({
        prompt,
        seed: seedInput.value ? (parseInt(seedInput.value) === -1 ? undefined : parseInt(seedInput.value)) : undefined,
        cfg: cfgInput.value ? parseFloat(cfgInput.value) : undefined,
        steps: stepsInput.value ? parseInt(stepsInput.value) : undefined,
      });
      
      // Guardar la última seed usada
      lastUsedSeed = seed;
      
      appState.setGeneratedImage(imageUrl);
    } catch (error) {
      appState.setError('Failed to generate image. Please try again.');
      console.error('Error generating image:', error);
      alert('Failed to generate image. Por favor, intenta de nuevo.');
    }
  });

  // Botón para recuperar la última seed
  document.getElementById('last-seed')?.addEventListener('click', () => {
    if (lastUsedSeed !== null) {
      const seedInput = document.getElementById('seed') as HTMLInputElement;
      seedInput.value = lastUsedSeed.toString();
    }
  });

  // Botón para establecer seed aleatorio
  document.getElementById('random-seed')?.addEventListener('click', () => {
    const seedInput = document.getElementById('seed') as HTMLInputElement;
    seedInput.value = '-1';
  });

  // Suscribirse a cambios de estado
  appState.subscribe((state) => {
    const generateButton = document.getElementById('generate') as HTMLButtonElement;
    if (generateButton) {
      generateButton.disabled = state.isLoading;
      generateButton.textContent = state.isLoading ? 'Generando...' : 'Generar Imagen';
    }

    if (state.error) {
      alert(state.error);
    }

    // Actualizar imagen generada e imágenes intermedias
    const generatedImage = document.getElementById('generatedImage');
    if (generatedImage) {
      if (state.isLoading && state.progress) {
        const percent = Math.round((state.progress.value / state.progress.max) * 100);
        generatedImage.innerHTML = `
          <div class="w-full flex flex-col items-center justify-center h-full">
            <div class="w-2/3 bg-gray-200 rounded-full h-6 mb-4 overflow-hidden">
              <div class="bg-indigo-600 h-6 rounded-full transition-all duration-300" style="width: ${percent}%;"></div>
            </div>
            <span class="text-indigo-700 font-semibold">${percent}%</span>
          </div>
        `;
      } else if (state.generatedImageUrl) {
        generatedImage.innerHTML = `
          <img src="${state.generatedImageUrl}" alt="Generated image" class="max-w-full max-h-full" />
        `;
      } else {
        generatedImage.innerHTML = '<p class="text-gray-500">Generated image will appear here</p>';
      }
    }
  });

  // Toggle Basic/Advanced
  const toggle = document.getElementById('toggle-advanced');
  const advancedFields = document.getElementById('advanced-fields');
  if (toggle && advancedFields) {
    toggle.addEventListener('change', (e) => {
      if ((toggle as HTMLInputElement).checked) {
        advancedFields.style.display = '';
      } else {
        advancedFields.style.display = 'none';
      }
    });
  }

  // Mostrar valores de sliders CFG y Steps
  const cfgRangeInput = document.getElementById('cfg-range') as HTMLInputElement | null;
  const cfgNumberInput = document.getElementById('cfg-number') as HTMLInputElement | null;

  if (cfgRangeInput && cfgNumberInput) {
    cfgRangeInput.addEventListener('input', () => {
      cfgNumberInput.value = parseFloat(cfgRangeInput.value).toFixed(2);
    });
    cfgNumberInput.addEventListener('input', () => {
      cfgRangeInput.value = cfgNumberInput.value;
      // Ensure the value is within range if typed manually
      if (parseFloat(cfgNumberInput.value) < parseFloat(cfgRangeInput.min)) {
        cfgNumberInput.value = cfgRangeInput.min;
      }
      if (parseFloat(cfgNumberInput.value) > parseFloat(cfgRangeInput.max)) {
        cfgNumberInput.value = cfgRangeInput.max;
      }
    });
    // Initialize the number input value
    cfgNumberInput.value = parseFloat(cfgRangeInput.value).toFixed(2);
  }

  const stepsRangeInput = document.getElementById('steps-range') as HTMLInputElement | null;
  const stepsNumberInput = document.getElementById('steps-number') as HTMLInputElement | null;

  if (stepsRangeInput && stepsNumberInput) {
    stepsRangeInput.addEventListener('input', () => {
      stepsNumberInput.value = stepsRangeInput.value;
    });
    stepsNumberInput.addEventListener('input', () => {
      stepsRangeInput.value = stepsNumberInput.value;
       // Ensure the value is within range if typed manually
      if (parseInt(stepsNumberInput.value) < parseInt(stepsRangeInput.min)) {
        stepsNumberInput.value = stepsRangeInput.min;
      }
      if (parseInt(stepsNumberInput.value) > parseInt(stepsRangeInput.max)) {
        stepsNumberInput.value = stepsRangeInput.max;
      }
    });
    // Initialize the number input value
    stepsNumberInput.value = stepsRangeInput.value;
  }
</script>
